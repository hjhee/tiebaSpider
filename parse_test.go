package main

import (
	"net/url"
	"strings"
	"testing"
	"time"

	"github.com/PuerkitoBio/goquery"
)

var lzlTotalCommentTestString = `<li class="lzl_single_post j_lzl_s_p first_no_border" data-field='{&quot;spid&quot;:132237789491,&quot;user_name&quot;:&quot;\u4ed6\u4eec\u597d\u5435\u554a&quot;,&quot;portrait&quot;:&quot;tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA&quot;}' ><a rel="noopener" name="132237789491"></a>  <a rel="noopener" data-field='{&quot;un&quot;:&quot;\u4ed6\u4eec\u597d\u5435\u554a&quot;,&quot;id&quot;:&quot;tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA&quot;}' target="_blank" class="j_user_card lzl_p_p" href="/home/main?un=%E4%BB%96%E4%BB%AC%E5%A5%BD%E5%90%B5%E5%95%8A&ie=utf-8&id=tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA&fr=pb" username="ä»–ä»¬å¥½åµå•Š"><img  src="https://gss0.bdstatic.com/6LZ1dD3d1sgCo2Kml5_Y_D3/sys/portrait/item/tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA"/></a><div class="lzl_cnt" data-field='{&quot;iconArr&quot;:[],&quot;free_flag&quot;:null}'><a rel="noopener" class="at j_user_card " data-field='{&quot;un&quot;:&quot;\u4ed6\u4eec\u597d\u5435\u554a&quot;,&quot;id&quot;:&quot;tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA&quot;}' href="/home/main/?un=%E4%BB%96%E4%BB%AC%E5%A5%BD%E5%90%B5%E5%95%8A&ie=utf-8&id=tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA&fr=pb" target="_blank" username="ä»–ä»¬å¥½åµå•Š">ç»ˆæé—ªè€€èµ›ç½—âœ¨</a>:<span class="lzl_content_main" data-username="">        å›å¤ <a href="http://tieba.baidu.com/i/sys/jump?un=" onclick="Stats.sendRequest('fr=tb0_forum&st_mod=pb&st_value=atlink');" onmouseover="showattip(this)" onmouseout="hideattip(this)" username="" portrait="tb.1.fdadc6ce.2U-v9D4pWAY7LIrg8E-EOw" target="_blank" class="at">é˜¿æ¯”é…±æœ€æ£’å•¦ğŸ’–</a> :è¯´èµ·æ¥çº¸ç‰‡äººæé¥­åœˆè¿™ä¸€å¥—å°±nmç¦»è°±<img class="BDE_Smiley" width="30" height="30" changedsize="false" src="https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon16.png" >        </span><div class="lzl_content_reply"><span class="lzl_jb" style="display:none;"></span><span class="lzl_op_list j_lzl_o_l" style="display:none;"></span><span class="lzl_time">2020-5-17 22:37</span><a rel="noopener" href="#" class="lzl_s_r">å›å¤</a></div></div></li><li class="lzl_single_post j_lzl_s_p " data-field='{&quot;spid&quot;:132237796500,&quot;user_name&quot;:&quot;\u4ed6\u4eec\u597d\u5435\u554a&quot;,&quot;portrait&quot;:&quot;tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA&quot;}' ><a rel="noopener" name="132237796500"></a>  <a rel="noopener" data-field='{&quot;un&quot;:&quot;\u4ed6\u4eec\u597d\u5435\u554a&quot;,&quot;id&quot;:&quot;tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA&quot;}' target="_blank" class="j_user_card lzl_p_p" href="/home/main?un=%E4%BB%96%E4%BB%AC%E5%A5%BD%E5%90%B5%E5%95%8A&ie=utf-8&id=tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA&fr=pb" username="ä»–ä»¬å¥½åµå•Š"><img  src="https://gss0.bdstatic.com/6LZ1dD3d1sgCo2Kml5_Y_D3/sys/portrait/item/tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA"/></a><div class="lzl_cnt" data-field='{&quot;iconArr&quot;:[],&quot;free_flag&quot;:null}'><a rel="noopener" class="at j_user_card " data-field='{&quot;un&quot;:&quot;\u4ed6\u4eec\u597d\u5435\u554a&quot;,&quot;id&quot;:&quot;tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA&quot;}' href="/home/main/?un=%E4%BB%96%E4%BB%AC%E5%A5%BD%E5%90%B5%E5%95%8A&ie=utf-8&id=tb.1.479b0e40.FbTmCIoclxiBD5JouhBQMA&fr=pb" target="_blank" username="ä»–ä»¬å¥½åµå•Š">ç»ˆæé—ªè€€èµ›ç½—âœ¨</a>:<span class="lzl_content_main" data-username="">        å›å¤ <a href="http://tieba.baidu.com/i/sys/jump?un=" onclick="Stats.sendRequest('fr=tb0_forum&st_mod=pb&st_value=atlink');" onmouseover="showattip(this)" onmouseout="hideattip(this)" username="" portrait="tb.1.fdadc6ce.2U-v9D4pWAY7LIrg8E-EOw" target="_blank" class="at">é˜¿æ¯”é…±æœ€æ£’å•¦ğŸ’–</a> :ç®—äº†ï¼Œå¤§ä½¬æ‰“æ¶æˆ‘è¿™èŒæ–°è¿˜æ˜¯ç¨ç¨å§<img class="BDE_Smiley" width="30" height="30" changedsize="false" src="https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon25.png" >        </span><div class="lzl_content_reply"><span class="lzl_jb" style="display:none;"></span><span class="lzl_op_list j_lzl_o_l" style="display:none;"></span><span class="lzl_time">2020-5-17 22:37</span><a rel="noopener" href="#" class="lzl_s_r">å›å¤</a></div></div></li><li class="lzl_single_post j_lzl_s_p " data-field='{&quot;spid&quot;:132240827250,&quot;user_name&quot;:&quot;lonelyrangers&quot;,&quot;portrait&quot;:&quot;tb.1.41c90085.pOmHdZ2UOe-_Na778rOFhA&quot;}' ><a rel="noopener" name="132240827250"></a>  <a rel="noopener" data-field='{&quot;un&quot;:&quot;lonelyrangers&quot;,&quot;id&quot;:&quot;tb.1.41c90085.pOmHdZ2UOe-_Na778rOFhA&quot;}' target="_blank" class="j_user_card lzl_p_p" href="/home/main?un=lonelyrangers&ie=utf-8&id=tb.1.41c90085.pOmHdZ2UOe-_Na778rOFhA&fr=pb" username="lonelyrangers"><img  src="https://gss0.bdstatic.com/6LZ1dD3d1sgCo2Kml5_Y_D3/sys/portrait/item/tb.1.41c90085.pOmHdZ2UOe-_Na778rOFhA"/></a><div class="lzl_cnt" data-field='{&quot;iconArr&quot;:{&quot;all_level&quot;:{&quot;2&quot;:{&quot;end_time&quot;:&quot;1608785198&quot;,&quot;level&quot;:2,&quot;pic_url&quot;:&quot;https:\/\/imgsa.baidu.com\/forum\/pic\/item\/6afa80cb39dbb6fdf9de234d0b24ab18962b37f0.jpg&quot;,&quot;score_limit&quot;:8000}},&quot;level&quot;:{&quot;end_time&quot;:&quot;1608785198&quot;,&quot;pic_url&quot;:&quot;https:\/\/imgsa.baidu.com\/forum\/pic\/item\/6afa80cb39dbb6fdf9de234d0b24ab18962b37f0.jpg&quot;,&quot;props_id&quot;:2}},&quot;free_flag&quot;:null}'><a rel="noopener" class="at j_user_card " data-field='{&quot;un&quot;:&quot;lonelyrangers&quot;,&quot;id&quot;:&quot;tb.1.41c90085.pOmHdZ2UOe-_Na778rOFhA&quot;}' href="/home/main/?un=lonelyrangers&ie=utf-8&id=tb.1.41c90085.pOmHdZ2UOe-_Na778rOFhA&fr=pb" target="_blank" username="lonelyrangers">lonelyrangers</a>:<span class="lzl_content_main" data-username="">        ä½ è¿™å½¢å®¹å¾—å¤ªæœ‰ç”»é¢æ„Ÿäº†<img class="BDE_Smiley" width="30" height="30" changedsize="false" src="https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon25.png" >        </span><div class="lzl_content_reply"><span class="lzl_jb" style="display:none;"></span><span class="lzl_op_list j_lzl_o_l" style="display:none;"></span><span class="lzl_time">2020-5-18 02:12</span><a rel="noopener" href="#" class="lzl_s_r">å›å¤</a></div></div></li><li class="lzl_single_post j_lzl_s_p " data-field='{&quot;spid&quot;:132252322102,&quot;user_name&quot;:&quot;\u73b0\u4ee3\u6dd1\u5973\u96be\u6c42\u554a&quot;,&quot;portrait&quot;:&quot;tb.1.a95746d1.CnZDCm-zX0WTKmf_9-iJYA&quot;}' ><a rel="noopener" name="132252322102"></a>  <a rel="noopener" data-field='{&quot;un&quot;:&quot;\u73b0\u4ee3\u6dd1\u5973\u96be\u6c42\u554a&quot;,&quot;id&quot;:&quot;tb.1.a95746d1.CnZDCm-zX0WTKmf_9-iJYA&quot;}' target="_blank" class="j_user_card lzl_p_p" href="/home/main?un=%E7%8E%B0%E4%BB%A3%E6%B7%91%E5%A5%B3%E9%9A%BE%E6%B1%82%E5%95%8A&ie=utf-8&id=tb.1.a95746d1.CnZDCm-zX0WTKmf_9-iJYA&fr=pb" username="ç°ä»£æ·‘å¥³éš¾æ±‚å•Š"><img  src="https://gss0.bdstatic.com/6LZ1dD3d1sgCo2Kml5_Y_D3/sys/portrait/item/tb.1.a95746d1.CnZDCm-zX0WTKmf_9-iJYA"/></a><div class="lzl_cnt" data-field='{&quot;iconArr&quot;:[],&quot;free_flag&quot;:null}'><a rel="noopener" class="at j_user_card " data-field='{&quot;un&quot;:&quot;\u73b0\u4ee3\u6dd1\u5973\u96be\u6c42\u554a&quot;,&quot;id&quot;:&quot;tb.1.a95746d1.CnZDCm-zX0WTKmf_9-iJYA&quot;}' href="/home/main/?un=%E7%8E%B0%E4%BB%A3%E6%B7%91%E5%A5%B3%E9%9A%BE%E6%B1%82%E5%95%8A&ie=utf-8&id=tb.1.a95746d1.CnZDCm-zX0WTKmf_9-iJYA&fr=pb" target="_blank" username="ç°ä»£æ·‘å¥³éš¾æ±‚å•Š">ç°ä»£æ·‘å¥³éš¾æ±‚å•Š</a>:<span class="lzl_content_main" data-username="">        å›å¤ <a href="http://tieba.baidu.com/i/sys/jump?un=" onclick="Stats.sendRequest('fr=tb0_forum&st_mod=pb&st_value=atlink');" onmouseover="showattip(this)" onmouseout="hideattip(this)" username="" portrait="tb.1.fdadc6ce.2U-v9D4pWAY7LIrg8E-EOw" target="_blank" class="at">é˜¿æ¯”é…±æœ€æ£’å•¦ğŸ’–</a> :æ˜¯ç§¦æ­¦é˜³<img class="BDE_Smiley" width="30" height="30" changedsize="false" src="https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon25.png" >        </span><div class="lzl_content_reply"><span class="lzl_jb" style="display:none;"></span><span class="lzl_op_list j_lzl_o_l" style="display:none;"></span><span class="lzl_time">2020-5-18 17:06</span><a rel="noopener" href="#" class="lzl_s_r">å›å¤</a></div></div></li><li class="lzl_single_post j_lzl_s_p " data-field='{&quot;spid&quot;:132252333701,&quot;user_name&quot;:&quot;470355389&quot;,&quot;portrait&quot;:&quot;tb.1.fdadc6ce.2U-v9D4pWAY7LIrg8E-EOw&quot;}' ><a rel="noopener" name="132252333701"></a>  <a rel="noopener" data-field='{&quot;un&quot;:&quot;470355389&quot;,&quot;id&quot;:&quot;tb.1.fdadc6ce.2U-v9D4pWAY7LIrg8E-EOw&quot;}' target="_blank" class="j_user_card lzl_p_p" href="/home/main?un=470355389&ie=utf-8&id=tb.1.fdadc6ce.2U-v9D4pWAY7LIrg8E-EOw&fr=pb" username="470355389"><img  src="https://gss0.bdstatic.com/6LZ1dD3d1sgCo2Kml5_Y_D3/sys/portrait/item/tb.1.fdadc6ce.2U-v9D4pWAY7LIrg8E-EOw"/></a><div class="lzl_cnt" data-field='{&quot;iconArr&quot;:{&quot;all_level&quot;:{&quot;2&quot;:{&quot;end_time&quot;:&quot;1617015024&quot;,&quot;level&quot;:2,&quot;pic_url&quot;:&quot;https:\/\/imgsa.baidu.com\/forum\/pic\/item\/6afa80cb39dbb6fdf9de234d0b24ab18962b37f0.jpg&quot;,&quot;score_limit&quot;:8000}},&quot;level&quot;:{&quot;end_time&quot;:&quot;1617015024&quot;,&quot;pic_url&quot;:&quot;https:\/\/imgsa.baidu.com\/forum\/pic\/item\/6afa80cb39dbb6fdf9de234d0b24ab18962b37f0.jpg&quot;,&quot;props_id&quot;:2}},&quot;free_flag&quot;:null}'><a rel="noopener" class="at j_user_card " data-field='{&quot;un&quot;:&quot;470355389&quot;,&quot;id&quot;:&quot;tb.1.fdadc6ce.2U-v9D4pWAY7LIrg8E-EOw&quot;}' href="/home/main/?un=470355389&ie=utf-8&id=tb.1.fdadc6ce.2U-v9D4pWAY7LIrg8E-EOw&fr=pb" target="_blank" username="470355389">é˜¿æ¯”é…±æœ€æ£’å•¦ğŸ’–</a>:<span class="lzl_content_main" data-username="">        å›å¤ <a href="http://tieba.baidu.com/i/sys/jump?un=" onclick="Stats.sendRequest('fr=tb0_forum&st_mod=pb&st_value=atlink');" onmouseover="showattip(this)" onmouseout="hideattip(this)" username="" portrait="tb.1.a95746d1.CnZDCm-zX0WTKmf_9-iJYA" target="_blank" class="at">ç°ä»£æ·‘å¥³éš¾æ±‚å•Š</a> :å•Šè¿™ï¼Œä¸¢äºº<img class="BDE_Smiley" width="30" height="30" changedsize="false" src="https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon11.png" >        </span><div class="lzl_content_reply"><span class="lzl_jb" style="display:none;"></span><span class="lzl_op_list j_lzl_o_l" style="display:none;"></span><span class="lzl_time">2020-5-18 17:07</span><a rel="noopener" href="#" class="lzl_s_r">å›å¤</a></div></div></li><li class="lzl_li_pager j_lzl_l_p lzl_li_pager_s" data-field='{&quot;total_num&quot;:15,&quot;total_page&quot;:2}' ><a rel="noopener" class="j_lzl_p btn-sub btn-small pull-right" href="##"><i class="icon-reply"></i>æˆ‘ä¹Ÿè¯´ä¸€å¥</a>                                <p class="j_pager l_pager pager_theme_2">      <a href="#1">é¦–é¡µ</a>
<a href="#1">ä¸Šä¸€é¡µ</a>
<a href="#1">1</a>
<span class="tP">2</span>
</p>    </li>`

func TestTotalCommentParserFcn(t *testing.T) {
	u := &url.URL{}
	body := lzlTotalCommentTestString
	commentParserFcn(u, body, HTMLLzl, func(int64) {}, func(key uint64, value *LzlContent) {
		// special rule: remove username ahref in ": å›å¤ ", as requested in #4
		strContent := string(value.Content)
		content := strings.Trim(strContent, " ")
		if strings.HasPrefix(content, "å›å¤") {
			doc, err := goquery.NewDocumentFromReader(strings.NewReader(content))
			if err != nil {
				t.Errorf("failed to parse comment data: %v, reason: %s", content, err)
			}
			bodyDOM := doc.Find("body")
			s := doc.Find("a.at").First()
			userNameHtml, _ := s.Html()
			// t.Errorf(userNameHtml)
			s.ReplaceWithHtml(userNameHtml)
			t.Errorf(bodyDOM.Html())
		}
	}, func(delay time.Duration, url *url.URL, pageType HTMLType) {}, func(string, string, string) {})
}
